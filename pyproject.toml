[build-system]
requires = ["setuptools>=45"]
build-backend = "setuptools.build_meta"

[project]
name = 'example-haskell-wheel'
version = '0.1.0a5'
authors = [{ name = 'Wen Kokke', email = 'wenkokke@users.noreply.github.com' }]
description = 'An experiment in publishing a Haskell library as a Python Wheel.'
readme = 'README.md'
license = { file = 'LICENSE' }
requires-python = ">=3.7,<3.12"

[project.optional-dependencies]
test = ["pytest >=7.1,<8"]

[project.scripts]
example-haskell-wheel = "example_haskell_wheel:main"

[tool.cibuildwheel]
# 17-04-2023:
# Cross-compilation with cibuildwheel does not work with Cabal.
archs = ["x86_64"]
skip = ["pp*", "*musllinux*"]
test-command = "pytest {package}/tests"
test-extras = "test"

[tool.cibuildwheel.linux]
before-all = [
  "ln -s /usr/lib64/libgmp.so.10 /usr/lib64/libgmp.so",
  "yum install -y wget",
  "wget -q https://downloads.haskell.org/~ghc/9.4.4/ghc-9.4.4-x86_64-centos7-linux.tar.xz -O /tmp/ghc.tar.xz",
  "mkdir /tmp/ghc",
  "tar xf /tmp/ghc.tar.xz -C /tmp/ghc --strip-components 1",
  "cd /tmp/ghc && ./configure",
  "cd /tmp/ghc && make install",
  "which ghc",
  "wget https://github.com/haskell/cabal/archive/refs/tags/cabal-install-v3.10.1.0.zip -O /tmp/cabal.zip",
  "mkdir /tmp/cabal",
  "unzip -q /tmp/cabal.zip -d /tmp && mv /tmp/cabal-cabal-install-v3.10.1.0 /tmp/cabal",
  "cd /tmp/cabal && python3.11 ./bootstrap/bootstrap.py -d ./bootstrap/linux-9.4.4.json -w /usr/local/bin/ghc-9.4.4",
  "which cabal"
]

[tool.tox]
legacy_tox_ini = """
[tox]
envlist = py37, py38, py39, py310, py311
isolated_build = true
skip_missing_interpreters = true

[testenv]
extras =
  test
commands =
  {envpython} -m pytest tests
"""
